<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat App</title>
</head>
<body>

<h2>Chat Application</h2>

<!-- TEXT -->
<input type="text" id="msgInput" placeholder="Enter message">
<button onclick="sendText()">Send Text</button>

<br><br>

<!-- FILE -->
<input type="file" id="fileInput">
<button onclick="sendFile()">Send File</button>

<br><br>

<progress id="progressBar" value="0" max="100" style="display:none;"></progress>
<p id="status"></p>

<hr>

<div id="msgBox"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io(window.location.origin);
    const msgBox = document.getElementById('msgBox');

    function sendText() {
        const msg = msgInput.value;
        if (!msg) return;

        socket.emit('msgFromFrontend', msg);
        msgInput.value = '';
    }

    function sendFile() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        if (!file) return;

        //  CLIENT-SIDE LIMIT
        if (file.size > 20 * 1024 * 1024) {
            alert('File too large! Max 20MB allowed.');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        const xhr = new XMLHttpRequest();
        const progressBar = document.getElementById('progressBar');
        const status = document.getElementById('status');

        progressBar.style.display = 'block';
        progressBar.value = 0;
        status.innerText = 'Uploading...';

        xhr.upload.onprogress = (e) => {
            if (e.lengthComputable) {
                progressBar.value = (e.loaded / e.total) * 100;
            }
        };

        xhr.onload = () => {
            progressBar.style.display = 'none';

            if (xhr.status === 200) {
                const data = JSON.parse(xhr.responseText);
                socket.emit('fileMessage', data);
                status.innerText = 'Upload complete ✔';
            } else {
                status.innerText = 'Upload failed ❌';
            }
        };

        xhr.onerror = () => {
            progressBar.style.display = 'none';
            status.innerText = 'Network error ❌';
        };

        xhr.open('POST', '/upload');
        xhr.send(formData);

        fileInput.value = '';
    }

    socket.on('msgFromBackend', (data) => {

        // TEXT
        if (data.type === 'text') {
            const p = document.createElement('p');
            p.innerText = data.msg;
            msgBox.appendChild(p);
            return;
        }

        const container = document.createElement('div');
        container.style.margin = '10px 0';

        // IMAGE
        if (data.fileType.startsWith('image')) {
            const img = document.createElement('img');
            img.src = data.fileUrl;
            img.width = 200;
            img.style.display = 'block';

            const d = document.createElement('a');
            d.href = data.fileUrl;
            d.download = data.fileName;
            d.innerText = '⬇ Download Image';

            container.appendChild(img);
            container.appendChild(d);
        }

        // VIDEO
        else if (data.fileType.startsWith('video')) {
            const video = document.createElement('video');
            video.src = data.fileUrl;
            video.controls = true;
            video.width = 300;
            video.style.display = 'block';

            const d = document.createElement('a');
            d.href = data.fileUrl;
            d.download = data.fileName;
            d.innerText = '⬇ Download Video';

            container.appendChild(video);
            container.appendChild(d);
        }

        // PDF
        else if (data.fileType === 'application/pdf') {
            const p = document.createElement('p');
            p.innerText = `${data.fileName}`;

            const view = document.createElement('a');
            view.href = data.fileUrl;
            view.target = '_blank';
            view.innerText = 'View PDF';

            const d = document.createElement('a');
            d.href = data.fileUrl;
            d.download = data.fileName;
            d.style.marginLeft = '10px';
            d.innerText = '⬇ Download PDF';

            container.appendChild(p);
            container.appendChild(view);
            container.appendChild(d);
        }

        msgBox.appendChild(container);
    });
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat App</title>
    <style>
        body { font-family: Arial; }
        #msgBox div { margin: 10px 0; }
        img, video { margin-top: 5px; }
    </style>
</head>
<body>

<h2>Chat Application</h2>

<input type="text" id="msgInput" placeholder="Enter message">
<button onclick="sendText()">Send Text</button>

<br><br>

<input type="file" id="fileInput">
<button onclick="sendFile()">Send File</button>

<br><br>

<progress id="progressBar" value="0" max="100" style="display:none;"></progress>
<p id="status"></p>

<hr>

<div id="msgBox"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
    let username = '';
    while (!username) {
        username = prompt("Enter your name:");
    }

    const socket = io(window.location.origin);
    socket.emit('join', username);

    const msgBox = document.getElementById('msgBox');
    const msgInput = document.getElementById('msgInput');

    function sendText() {
        if (!msgInput.value) return;
        socket.emit('msgFromFrontend', msgInput.value);
        msgInput.value = '';
    }

    function sendFile() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        if (!file) return;

        if (file.size > 20 * 1024 * 1024) {
            alert('Max 20MB allowed');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        const xhr = new XMLHttpRequest();
        const progressBar = document.getElementById('progressBar');
        const status = document.getElementById('status');

        progressBar.style.display = 'block';
        progressBar.value = 0;
        status.innerText = 'Uploading...';

        xhr.upload.onprogress = (e) => {
            if (e.lengthComputable) {
                progressBar.value = (e.loaded / e.total) * 100;
            }
        };

        xhr.onload = () => {
            progressBar.style.display = 'none';
            if (xhr.status === 200) {
                const data = JSON.parse(xhr.responseText);
                socket.emit('fileMessage', data);
                status.innerText = 'Upload complete ✔';
            } else {
                status.innerText = 'Upload failed ❌';
            }
        };

        xhr.onerror = () => {
            progressBar.style.display = 'none';
            status.innerText = 'Network error ❌';
        };

        xhr.open('POST', '/upload');
        xhr.send(formData);
        fileInput.value = '';
    }

    socket.on('msgFromBackend', (data) => {

        // SYSTEM MESSAGE
        if (data.type === 'system') {
            const p = document.createElement('p');
            p.innerText = data.msg;
            p.style.color = 'gray';
            msgBox.appendChild(p);
            return;
        }

        // TEXT MESSAGE
        if (data.type === 'text') {
            const p = document.createElement('p');
            p.innerText = `${data.sender}: ${data.msg}`;
            msgBox.appendChild(p);
            return;
        }

        // FILE MESSAGE
        const container = document.createElement('div');

        const sender = document.createElement('p');
        sender.innerText = `${data.sender} sent a file:`;
        sender.style.fontWeight = 'bold';
        container.appendChild(sender);

        if (data.fileType.startsWith('image')) {
            const img = document.createElement('img');
            img.src = data.fileUrl;
            img.width = 200;
            container.appendChild(img);
        }
        else if (data.fileType.startsWith('video')) {
            const video = document.createElement('video');
            video.src = data.fileUrl;
            video.controls = true;
            video.width = 300;
            container.appendChild(video);
        }
        else if (data.fileType === 'application/pdf') {
            const a = document.createElement('a');
            a.href = data.fileUrl;
            a.target = '_blank';
            a.innerText = 'View PDF';
            container.appendChild(a);
        }

        const d = document.createElement('a');
        d.href = data.fileUrl;
        d.download = data.fileName;
        d.style.display = 'block';
        d.innerText = '⬇ Download';
        container.appendChild(d);

        msgBox.appendChild(container);
    });
</script>

</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <title>Chat App</title>
    <style>
        body { font-family: Arial; }
        #msgBox div {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
        }
        .comment {
            margin-left: 20px;
            font-size: 14px;
            color: darkblue;
        }
    </style>
</head>
<body>

<h2>Chat Application</h2>

<input type="text" id="msgInput" placeholder="Enter message">
<button onclick="sendText()">Send Text</button>

<br><br>

<input type="file" id="fileInput">
<button onclick="sendFile()">Send File</button>

<br><br>

<progress id="progressBar" value="0" max="100" style="display:none;"></progress>
<p id="status"></p>

<hr>

<div id="msgBox"></div>

<script src="/socket.io/socket.io.js"></script>
<script>

let username = '';
while (!username) {
    username = prompt("Enter your name:");
}

const socket = io();
socket.emit('join', username);

const msgBox = document.getElementById('msgBox');
const msgInput = document.getElementById('msgInput');

function sendText() {
    if (!msgInput.value) return;
    socket.emit('msgFromFrontend', msgInput.value);
    msgInput.value = '';
}

function sendFile() {
    const file = document.getElementById('fileInput').files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);

    const xhr = new XMLHttpRequest();
    const progressBar = document.getElementById('progressBar');
    const status = document.getElementById('status');

    progressBar.style.display = 'block';

    xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) {
            progressBar.value = (e.loaded / e.total) * 100;
        }
    };

    xhr.onload = () => {
        progressBar.style.display = 'none';
        const data = JSON.parse(xhr.responseText);
        socket.emit('fileMessage', data);
        status.innerText = 'Upload complete ✔';
    };

    xhr.open('POST', '/upload');
    xhr.send(formData);
}

socket.on('msgFromBackend', (data) => {

    if (data.type === 'system') {
        const p = document.createElement('p');
        p.innerText = data.msg;
        p.style.color = 'gray';
        msgBox.appendChild(p);
        return;
    }

    const container = document.createElement('div');
    container.id = data.messageId;

    if (data.type === 'text') {
        container.innerHTML = `<b>${data.sender}</b>: ${data.msg}`;
    }

    if (data.type === 'file') {
        container.innerHTML = `<b>${data.sender}</b> sent a file:<br>`;

        if (data.fileType.startsWith('image')) {
            container.innerHTML += `<img src="${data.fileUrl}" width="200"><br>`;
        }

        container.innerHTML += `<a href="${data.fileUrl}" download>⬇ Download</a>`;
    }

    // COMMENT SECTION
    container.innerHTML += `
        <br><input type="text" placeholder="Write comment..." id="c-${data.messageId}">
        <button onclick="sendComment('${data.messageId}')">Comment</button>
        <div id="comments-${data.messageId}"></div>
    `;

    msgBox.appendChild(container);
});

function sendComment(messageId) {
    const input = document.getElementById(`c-${messageId}`);
    if (!input.value) return;

    socket.emit('commentMessage', {
        messageId,
        comment: input.value
    });

    input.value = '';
}

socket.on('newComment', (data) => {
    const commentDiv = document.getElementById(`comments-${data.messageId}`);
    if (!commentDiv) return;

    const p = document.createElement('p');
    p.className = 'comment';
    p.innerHTML = `<b>${data.sender}</b>: ${data.comment}`;

    commentDiv.appendChild(p);
});

</script>

</body>
</html>
